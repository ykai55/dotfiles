#!/usr/bin/env python3
# tmux-load
# Restore tmux topology from a tmux-dump JSON file.
#
# Usage:
#   tmux-load path/to/tmux.json
#   tmux-load --session name path/to/tmux.json
#   tmux-load -f path/to/tmux.json
#   tmux-load -a path/to/tmux.json
#   tmux-load --run-commands path/to/tmux.json

from __future__ import annotations

import argparse
import json
import os
import shlex
import subprocess
import sys
from typing import Any, Dict, List, Optional, Tuple


def run_tmux(args: List[str]) -> Tuple[int, str, str]:
    proc = subprocess.run(["tmux"] + args, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    return proc.returncode, proc.stdout, proc.stderr


PENDING_COMMANDS: List[List[str]] = []


def tmux_queue(args: List[str]) -> None:
    PENDING_COMMANDS.append(args)


def tmux_flush() -> None:
    if not PENDING_COMMANDS:
        return
    combined: List[str] = []
    for idx, cmd in enumerate(PENDING_COMMANDS):
        if idx:
            combined.append(";")
        combined.extend(cmd)
    PENDING_COMMANDS.clear()
    rc, out, err = run_tmux(combined)
    if rc != 0:
        raise RuntimeError(err.strip() or f"tmux failed: {' '.join(combined)}")


def tmux_ok(args: List[str]) -> bool:
    tmux_flush()
    rc, _, _ = run_tmux(args)
    return rc == 0


def tmux_out(args: List[str]) -> str:
    tmux_flush()
    rc, out, err = run_tmux(args)
    if rc != 0:
        raise RuntimeError(err.strip() or f"tmux failed: {' '.join(args)}")
    return out


def session_exists(name: str) -> bool:
    return tmux_ok(["has-session", "-t", name])


def kill_session(name: str) -> None:
    tmux_queue(["kill-session", "-t", name])


def unique_session_name(base: str) -> str:
    if not session_exists(base):
        return base
    idx = 1
    while True:
        candidate = f"{base}({idx})"
        if not session_exists(candidate):
            return candidate
        idx += 1


def session_target(name: str) -> str:
    return f"{name}:"


def list_pane_ids_by_index(target: str) -> Dict[int, str]:
    out = tmux_out(["list-panes", "-t", target, "-F", "#{pane_index}\t#{pane_id}"])
    res: Dict[int, str] = {}
    for line in out.splitlines():
        if not line.strip():
            continue
        parts = line.split("\t", 1)
        if len(parts) != 2:
            continue
        try:
            idx = int(parts[0])
        except ValueError:
            continue
        res[idx] = parts[1]
    return res


def current_session_name() -> Optional[str]:
    rc, out, _ = run_tmux(["display-message", "-p", "#{session_name}"])
    if rc != 0:
        return None
    return out.strip() or None


def current_window_id() -> Optional[str]:
    try:
        out = tmux_out(["display-message", "-p", "#{window_id}"])
    except Exception:
        return None
    return out.strip() or None


def is_empty_session(name: str, allow_current_pane: bool) -> bool:
    try:
        windows = tmux_out(["list-windows", "-t", session_target(name), "-F", "#{window_index}"])
        win_lines = [ln for ln in windows.splitlines() if ln.strip()]
        if len(win_lines) != 1:
            return False

        panes = tmux_out(
            [
                "list-panes",
                "-t",
                session_target(name),
                "-F",
                "#{pane_id}\t#{pane_index}\t#{pane_current_command}\t#{pane_in_mode}",
            ]
        )
        pane_lines = [ln for ln in panes.splitlines() if ln.strip()]
        if len(pane_lines) != 1:
            return False

        parts = pane_lines[0].split("\t")
        if len(parts) < 4:
            return False
        pane_id = parts[0].strip()
        cmd = parts[2].strip()
        in_mode = parts[3].strip()
        if in_mode == "1":
            return False

        current_pane = os.environ.get("TMUX_PANE") if allow_current_pane else None
        if current_pane and pane_id == current_pane:
            return True

        shells = {"sh", "bash", "zsh", "fish", "nu", "tcsh", "csh", "ksh"}
        return cmd in shells or cmd == ""
    except Exception:
        return False


def is_empty_current_session() -> bool:
    if "TMUX" not in os.environ:
        return False
    sname = current_session_name()
    if not sname:
        return False
    return is_empty_session(sname, allow_current_pane=True)


def normalize_path(path: str) -> str:
    if path.startswith("file://"):
        path = path[len("file://") :]
        if not path.startswith("/"):
            idx = path.find("/")
            if idx != -1:
                path = path[idx:]
    if path and not path.startswith("/"):
        idx = path.find("/")
        if idx != -1:
            path = path[idx:]
    return path


def normalize_start_command(cmd: Any) -> str:
    if cmd is None:
        return ""
    if isinstance(cmd, list):
        return shlex.join([str(item) for item in cmd])
    return str(cmd)


def session_name_from_dump(data: Dict[str, Any]) -> Optional[str]:
    if "sessions" in data and isinstance(data.get("sessions"), list):
        sessions = data.get("sessions") or []
        if not sessions:
            return None
        session = sessions[0] or {}
        return session.get("name") or session.get("session_name")
    if "windows" in data or "name" in data or "session_name" in data:
        return data.get("name") or data.get("session_name")
    return None


def ensure_window_panes(
    target: str,
    panes: List[Dict[str, Any]],
    run_commands: bool,
    sort_by_index: bool = True,
) -> None:
    if not panes:
        return

    panes_sorted = sorted(panes, key=lambda p: p.get("index", 0)) if sort_by_index else list(panes)
    prev_pane: Optional[Dict[str, Any]] = panes_sorted[0]
    for pane in panes_sorted[1:]:
        path = normalize_path(pane.get("path") or "")
        cmd = ["split-window", "-t", target]
        if prev_pane:
            prev_geom = prev_pane.get("geometry") or {}
            geom = pane.get("geometry") or {}
            try:
                prev_left = int(prev_geom.get("left"))
                prev_top = int(prev_geom.get("top"))
                left = int(geom.get("left"))
                top = int(geom.get("top"))
                if top == prev_top and left != prev_left:
                    cmd.append("-h")
                elif left == prev_left and top != prev_top:
                    cmd.append("-v")
            except Exception:
                pass
        if path:
            cmd.extend(["-c", path])
        tmux_queue(cmd)
        prev_pane = pane

    # Apply titles and run commands
    pane_map = list_pane_ids_by_index(target)
    for pane in panes_sorted:
        try:
            idx = int(pane.get("index", 0))
        except Exception:
            continue
        pane_id = pane_map.get(idx)
        if not pane_id:
            continue
        title = pane.get("title") or ""
        if title:
            tmux_queue(["select-pane", "-t", pane_id, "-T", title])

        if run_commands:
            cmd = normalize_start_command(pane.get("start_command"))
            if cmd:
                tmux_queue(["send-keys", "-t", pane_id, cmd, "Enter"])

    # Select active pane if indicated
    active_idx = None
    for pane in panes_sorted:
        if pane.get("active"):
            active_idx = pane.get("index")
            break
    if active_idx is not None:
        try:
            tmux_queue(["select-pane", "-t", f"{target}.{int(active_idx)}"])
        except Exception:
            pass
    tmux_flush()


def apply_window_options(window_id: str, window: Dict[str, Any]) -> None:
    automatic_rename = window.get("automatic_rename")
    if automatic_rename:
        tmux_queue(["set-window-option", "-t", window_id, "automatic-rename", str(automatic_rename)])




def restore_from_dump(
    data: Dict[str, Any],
    force: bool,
    append: bool,
    run_commands: bool,
    target_session: Optional[str],
) -> None:
    if "sessions" in data and isinstance(data.get("sessions"), list):
        sessions = data.get("sessions") or []
    elif "windows" in data or "name" in data or "session_name" in data:
        sessions = [data]
    else:
        raise RuntimeError("invalid tmux dump format")

    session = sessions[0] if sessions else {}
    sname = target_session or session.get("name") or session.get("session_name")
    if not sname:
        raise RuntimeError("missing target session name")

    in_tmux = "TMUX" in os.environ
    current_session = current_session_name() if in_tmux else None
    target_is_current = bool(current_session and sname == current_session)

    windows = session.get("windows") or []
    windows_sorted = sorted(windows, key=lambda w: w.get("index", 0))
    if not windows_sorted:
        return

    exists = session_exists(sname)
    session_empty = False
    if exists:
        if force:
            if target_is_current:
                tmux_queue(["kill-window", "-a", "-t", session_target(sname)])
                session_empty = True
            else:
                kill_session(sname)
                exists = False
        else:
            session_empty = is_empty_session(sname, allow_current_pane=target_is_current)
            if not append and not session_empty:
                raise RuntimeError("target session is not empty (use -f to clear or -a to append)")

    if not exists:
        sname = unique_session_name(sname)

    reuse_current = bool(exists and target_is_current and (force or session_empty))
    append_mode = bool(exists and (append or session_empty or reuse_current))

    window_id_by_index: Dict[int, str] = {}

    if append_mode:
        original_window_id = None
        if reuse_current:
            original_window_id = current_window_id()
        elif session_empty:
            win_id = tmux_out(["list-windows", "-t", session_target(sname), "-F", "#{window_id}"]).strip()
            original_window_id = win_id or None
        for win in windows_sorted:
            wname = win.get("name") or ""
            panes = win.get("panes") or []
            wpath = ""
            if panes:
                wpath = normalize_path(panes[0].get("path") or "")
            win_id = tmux_out(
                [
                    "new-window",
                    "-P",
                    "-t",
                    session_target(sname),
                    "-n",
                    wname,
                    "-c",
                    wpath,
                    "-F",
                    "#{window_id}",
                ]
            ).strip()
            window_id_by_index[int(win.get("index", 0))] = win_id
            ensure_window_panes(win_id, panes, run_commands, sort_by_index=False)
            apply_window_options(win_id, win)

            layout = win.get("layout") or ""
            if layout:
                tmux_queue(["select-layout", "-t", win_id, layout])

        if (reuse_current or session_empty) and original_window_id:
            tmux_queue(["kill-window", "-t", original_window_id])
    else:
        
        first_window = windows_sorted[0]
        first_name = first_window.get("name") or ""
        first_panes = first_window.get("panes") or []
        first_path = ""
        if first_panes:
            first_path = normalize_path(first_panes[0].get("path") or "")
        first_index = int(first_window.get("index", 0))

        first_win_id = tmux_out(
            ["new-session", "-d", "-s", sname, "-n", first_name, "-c", first_path, "-P", "-F", "#{window_id}"]
        ).strip()
        window_id_by_index[first_index] = first_win_id
        ensure_window_panes(first_win_id, first_panes, run_commands)
        apply_window_options(first_win_id, first_window)

        for win in windows_sorted[1:]:
            widx = int(win.get("index", 0))
            wname = win.get("name") or ""
            panes = win.get("panes") or []
            wpath = ""
            if panes:
                wpath = normalize_path(panes[0].get("path") or "")
            win_id = tmux_out(
                [
                    "new-window",
                    "-P",
                    "-t",
                    session_target(sname),
                    "-n",
                    wname,
                    "-c",
                    wpath,
                    "-F",
                    "#{window_id}",
                ]
            ).strip()
            window_id_by_index[widx] = win_id
            ensure_window_panes(win_id, panes, run_commands)
            apply_window_options(win_id, win)

            layout = win.get("layout") or ""
            if layout:
                tmux_queue(["select-layout", "-t", win_id, layout])

    # Select active window if specified
    active_idx = None
    for win in windows_sorted:
        if win.get("active"):
            active_idx = win.get("index")
            break
    if active_idx is not None:
        try:
            win_id = window_id_by_index.get(int(active_idx))
            if win_id:
                tmux_queue(["select-window", "-t", win_id])
        except Exception:
            pass
    tmux_flush()


def main() -> int:
    parser = argparse.ArgumentParser(description="Restore tmux from tmux-dump JSON.")
    parser.add_argument("dump_file", help="Path to tmux-dump JSON file")
    parser.add_argument("--session", help="Target tmux session name")
    parser.add_argument("-f", "--force", action="store_true", help="Clear target session before restore")
    parser.add_argument("-a", "--append", action="store_true", help="Append windows to target session")
    parser.add_argument(
        "--run-commands",
        action="store_true",
        help="Run pane start_command during restore",
    )
    args = parser.parse_args()

    try:
        with open(args.dump_file, "r", encoding="utf-8") as f:
            data = json.load(f)
    except Exception as exc:
        print(f"ERROR: failed to read dump file: {exc}", file=sys.stderr)
        return 2

    if args.force and args.append:
        print("ERROR: -f and -a cannot be used together", file=sys.stderr)
        return 2

    target_session = args.session
    dump_session = session_name_from_dump(data)
    current_session = current_session_name() if "TMUX" in os.environ else None
    in_tmux = current_session is not None
    if not target_session:
        if in_tmux:
            target_session = current_session
        else:
            target_session = dump_session

    if not target_session:
        print("ERROR: --session is required when dump has no session name and not inside tmux", file=sys.stderr)
        return 2

    if not in_tmux and not args.session and dump_session:
        if session_exists(dump_session):
            target_session = unique_session_name(dump_session)

    if (
        not args.session
        and current_session
        and dump_session
        and target_session == current_session
        and dump_session != current_session
    ):
        new_name = dump_session
        if session_exists(new_name):
            new_name = unique_session_name(new_name)
        tmux_out(["rename-session", "-t", current_session, new_name])
        target_session = new_name
        current_session = new_name

    try:
        restore_from_dump(data, args.force, args.append, args.run_commands, target_session)
    except Exception as exc:
        print(f"ERROR: {exc}", file=sys.stderr)
        return 1

    if in_tmux:
        if current_session != target_session:
            tmux_out(["switch-client", "-t", target_session])
    else:
        tmux_out(["attach-session", "-t", target_session])

    return 0


if __name__ == "__main__":
    raise SystemExit(main())
